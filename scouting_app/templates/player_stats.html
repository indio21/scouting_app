{% extends "base.html" %}
{% block title %}Historial de {{ player.name }}{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-body">
        <h1 class="h3 mb-3">Historial de rendimiento: {{ player.name }}</h1>
        <p class="text-muted mb-0">
            Carga la informacion que tenes en tus planillas o notas. Usa una fila por partido o semana.
            Solo los campos completados se guardan; los demas quedan en cero o vacios.
        </p>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">Nuevo registro</div>
            <div class="card-body">
                <form method="post">
                    <input type="hidden" name="action" value="add">
                    <div class="mb-3">
                        <label class="form-label" for="record_date">Fecha</label>
                        <input class="form-control" type="date" id="record_date" name="record_date" value="{{ request.form.record_date or '' }}" required>
                        <div class="form-text">Usa la fecha del partido o de la semana observada.</div>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label">Partidos</label>
                            <input class="form-control" type="number" name="matches_played" min="0" value="{{ request.form.matches_played or 0 }}">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Minutos</label>
                            <input class="form-control" type="number" name="minutes_played" min="0" value="{{ request.form.minutes_played or 0 }}">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Goles</label>
                            <input class="form-control" type="number" name="goals" min="0" value="{{ request.form.goals or 0 }}">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Asistencias</label>
                            <input class="form-control" type="number" name="assists" min="0" value="{{ request.form.assists or 0 }}">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Amarillas</label>
                            <input class="form-control" type="number" name="yellow_cards" min="0" value="{{ request.form.yellow_cards or 0 }}">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Rojas</label>
                            <input class="form-control" type="number" name="red_cards" min="0" value="{{ request.form.red_cards or 0 }}">
                        </div>
                    </div>
                    <div class="row g-3 mt-1">
                        <div class="col-12">
                            <label class="form-label">% pases acertados</label>
                            <input class="form-control" type="number" name="pass_accuracy" min="0" max="100" step="0.1" placeholder="Ej: 85.4">
                        </div>
                        <div class="col-12">
                            <label class="form-label">% disparos a puerta</label>
                            <input class="form-control" type="number" name="shot_accuracy" min="0" max="100" step="0.1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">% duelos ganados</label>
                            <input class="form-control" type="number" name="duels_won_pct" min="0" max="100" step="0.1">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Valoracion final (1 a 10)</label>
                            <input class="form-control" type="number" name="final_score" min="1" max="10" step="0.1" placeholder="Deja vacio para calcular automaticamente">
                            <div class="form-text">Si lo dejas vacio, la app calcula un puntaje sugerido segun los datos cargados.</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Notas</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Lesion leve, buen liderazgo, se mostro ansioso..."></textarea>
                    </div>
                    <div class="d-grid mt-4">
                        <button class="btn btn-success" type="submit">Guardar registro</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                <span>Historial completo</span>
                <form method="post" class="d-inline">
                    <input type="hidden" name="action" value="recalculate">
                    <button class="btn btn-outline-primary btn-sm" type="submit">Recalcular potencial con historial</button>
                </form>
            </div>
            <div class="card-body">
                {% if stats %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Part.</th>
                                <th>Min.</th>
                                <th>Goles</th>
                                <th>Asist.</th>
                                <th>% pases</th>
                                <th>% disparos</th>
                                <th>% duelos</th>
                                <th>Puntaje</th>
                                <th>Notas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in stats %}
                            <tr>
                                <td>{{ stat.record_date }}</td>
                                <td>{{ stat.matches_played }}</td>
                                <td>{{ stat.minutes_played }}</td>
                                <td>{{ stat.goals }}</td>
                                <td>{{ stat.assists }}</td>
                                <td>{{ stat.pass_accuracy if stat.pass_accuracy is not none else '--' }}</td>
                                <td>{{ stat.shot_accuracy if stat.shot_accuracy is not none else '--' }}</td>
                                <td>{{ stat.duels_won_pct if stat.duels_won_pct is not none else '--' }}</td>
                                <td>{{ stat.final_score if stat.final_score is not none else '--' }}</td>
                                <td>{{ stat.notes or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="stats-summary mt-3">
                    <div class="alert alert-light border">
                        <div class="fw-semibold mb-1">Resumen:</div>
                        <ul class="list-inline mb-0 small">
                            <li class="list-inline-item">Partidos: {{ summary.total_matches }}</li>
                            <li class="list-inline-item">Goles: {{ summary.total_goals }}</li>
                            <li class="list-inline-item">Asistencias: {{ summary.total_assists }}</li>
                            <li class="list-inline-item">Minutos: {{ summary.total_minutes }}</li>
                            <li class="list-inline-item">Puntaje promedio: {{ summary.avg_final_score or '--' }}</li>
                        </ul>
                    </div>
                </div>
                {% else %}
                <p class="text-muted mb-0">Todavia no hay registros cargados. Usa el formulario para comenzar.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="mt-4 d-flex flex-wrap gap-2">
    <a class="btn btn-secondary" href="{{ url_for('player_detail', player_id=player.id) }}">Volver a la ficha</a>
    <a class="btn btn-outline-success" href="{{ url_for('player_attributes', player_id=player.id) }}">Gestionar atributos</a>
    <a class="btn btn-outline-primary" href="{{ url_for('predict_player', player_id=player.id) }}">Ir a proyeccion</a>
</div>
{% endblock %}

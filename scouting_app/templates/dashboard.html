{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-3">
    <div>
        <h2 class="mb-1">Dashboard de scouting</h2>
        <p class="text-muted mb-0">Visor general con datos agregados que se actualizan cuando cargas atributos o estadisticas.</p>
    </div>
    <div class="mt-3 mt-lg-0 d-grid gap-2 d-lg-block">
        <a class="btn btn-outline-success" href="{{ url_for('manage_players') }}">Agregar jugadores</a>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small mb-1">Total de jugadores</h6>
                <div class="display-6 fw-bold">{{ total_players }}</div>
            </div>
        </div>
    </div>
    <div class="col-sm-6 col-lg-3">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="text-muted text-uppercase small mb-1">Puntaje medio historial</h6>
                <div class="display-6 fw-bold">{{ final_score_avg if final_score_avg is not none else '--' }}</div>
                <small class="text-muted">Promedio de valoraciones 1-10</small>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">Distribucion por posicion</div>
            <div class="card-body">
                <canvas id="positionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">Clasificacion de potencial</div>
            <div class="card-body">
                <canvas id="potentialChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">Promedio de atributos (0-20)</div>
    <div class="card-body">
        <canvas id="averageChart"></canvas>
    </div>
</div>

<div class="row g-4 mt-1">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">Top 10 jugadores por potencial</div>
            <div class="card-body p-0">
                <div class="table-responsive mb-0">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Jugador</th>
                                <th>Probabilidad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_potential %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="fw-semibold">{{ row.name }}</div>
                                    <small class="text-muted">ID {{ row.id }}</small>
                                </td>
                                <td>{{ (row.probability * 100)|round(1) }}% <span class="text-muted">({{ row.category }})</span></td>
                                <td>
                                    <a class="btn btn-sm btn-outline-primary w-100 w-lg-auto" href="{{ url_for('predict_player', player_id=row.id) }}">Ver proyeccion</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-3 text-muted">Carga datos para ver el ranking de potencial.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                <div class="d-flex flex-column">
                    <span>Mejor evolucion en el periodo</span>
                    <small class="text-muted">Delta de puntaje (ultimo - primero)</small>
                </div>
            </div>
            <div class="card-body">
                <form method="get" class="row g-2 align-items-end mb-3">
                    <div class="col-sm-4">
                        <label class="form-label small">Periodo</label>
                        <select class="form-select form-select-sm" name="period">
                            <option value="week" {% if selected_period == 'week' %}selected{% endif %}>Ultima semana</option>
                            <option value="month" {% if selected_period == 'month' %}selected{% endif %}>Ultimo mes</option>
                            <option value="year" {% if selected_period == 'year' %}selected{% endif %}>Ultimo ano</option>
                            <option value="custom" {% if selected_period == 'custom' %}selected{% endif %}>Rango personalizado</option>
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <label class="form-label small">Desde</label>
                        <input type="date" class="form-control form-control-sm" name="start" value="{{ start_date_str }}">
                    </div>
                    <div class="col-sm-4">
                        <label class="form-label small">Hasta</label>
                        <input type="date" class="form-control form-control-sm" name="end" value="{{ end_date_str }}">
                    </div>
                    <div class="col-12 text-end">
                        <button type="submit" class="btn btn-sm btn-outline-primary">Aplicar</button>
                    </div>
                </form>
                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Jugador</th>
                                <th>Delta</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in top_evolution %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>
                                    <div class="fw-semibold">{{ row.name }}</div>
                                    <small class="text-muted">ID {{ row.id }}</small>
                                </td>
                                <td>{{ row.delta }}</td>
                                <td>
                                    <a class="btn btn-sm btn-outline-primary w-100 w-lg-auto" href="{{ url_for('predict_player', player_id=row.id) }}">Ver proyeccion</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-3 text-muted">No hay registros en el periodo seleccionado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const positionCtx = document.getElementById('positionChart');
if (positionCtx && window.Chart) {
    new Chart(positionCtx, {
        type: 'bar',
        data: {
            labels: {{ positions|tojson }},
            datasets: [{
                label: 'Cantidad de jugadores',
                data: {{ pos_values|tojson }},
                backgroundColor: 'rgba(37, 99, 235, 0.5)',
                borderColor: 'rgba(37, 99, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
    });
}

const potCtx = document.getElementById('potentialChart');
if (potCtx && window.Chart) {
    new Chart(potCtx, {
        type: 'doughnut',
        data: {
            labels: {{ pot_labels|tojson }},
            datasets: [{
                data: {{ pot_values|tojson }},
                backgroundColor: ['#22c55e', '#facc15', '#ef4444', '#cbd5f5']
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });
}

const avgCtx = document.getElementById('averageChart');
if (avgCtx && window.Chart) {
    new Chart(avgCtx, {
        type: 'bar',
        data: {
            labels: {{ avg_labels|tojson }},
            datasets: [{
                label: 'Promedio',
                data: {{ avg_values|tojson }},
                backgroundColor: 'rgba(13, 110, 253, 0.45)',
                borderColor: '#0d6efd',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, max: 20 }
            }
        }
    });
}
</script>
{% endblock %}
